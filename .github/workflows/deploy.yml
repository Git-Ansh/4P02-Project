name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18'

jobs:
  test-backend:
    name: Test Backend
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        cd backend
        pip install -r requirements.txt
    
    - name: Run backend tests
      run: |
        cd backend
        pytest tests/ -v || echo "No tests found yet"

  # test-frontend:
  #   name: Test Frontend
  #   runs-on: ubuntu-latest
  #   
  #   steps:
  #   - uses: actions/checkout@v4
  #   
  #   - name: Set up Node.js
  #     uses: actions/setup-node@v4
  #     with:
  #       node-version: ${{ env.NODE_VERSION }}
  #       cache: 'npm'
  #       cache-dependency-path: frontend/package-lock.json
  #   
  #   - name: Install dependencies
  #     run: |
  #       cd frontend
  #       npm ci
  #   
  #   - name: Run frontend tests
  #     run: |
  #       cd frontend
  #       npm test

  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    needs: [test-backend]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Deploy to VPS via SSH
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        key: ${{ secrets.VPS_SSH_KEY }}
        passphrase: ${{ secrets.VPS_SSH_PASSPHRASE }}
        port: ${{ secrets.VPS_PORT }}
        script: |
          cd ~/COSC_4P02/Project/4P02-Project
          
          # Pull latest changes
          git pull origin main
          
          # Copy environment file if it doesn't exist
          if [ ! -f .env ]; then
            cp .env.example .env
            echo "‚ö†Ô∏è  Created .env from .env.example - please configure it!"
          fi
          
          # Stop existing containers
          docker-compose down
          
          # Build and start services
          docker-compose up -d --build
          
          # Show running containers
          docker-compose ps
          
          echo "‚úÖ Deployment completed successfully!"

  notify:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [deploy]
    if: always()
    
    steps:
    - name: Deployment Success
      if: needs.deploy.result == 'success'
      run: echo "üéâ Deployment to VPS successful!"
    
    - name: Deployment Failed
      if: needs.deploy.result == 'failure'
      run: |
        echo "‚ùå Deployment failed!"
        exit 1
